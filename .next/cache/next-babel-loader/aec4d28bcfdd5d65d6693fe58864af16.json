{"ast":null,"code":"const MongoClient = require('mongodb').MongoClient;\n\nconst assert = require('assert');\n\nconst bcrypt = require('bcrypt');\n\nconst v4 = require('uuid').v4;\n\nconst jwt = require('jsonwebtoken');\n\nconst jwtSecret = 'SUPERSECRETE20220';\nconst saltRounds = 10;\nconst url = process.env.url;\nconst dbName = process.env.dbName;\nconst client = new MongoClient(url, {\n  useNewUrlParser: true,\n  useUnifiedTopology: true\n});\n\nfunction findUser(db, email, callback) {\n  const collection = db.collection(process.env.dbcollection);\n  collection.findOne({\n    email\n  }, callback);\n}\n\nfunction createUser(db, email, password, callback) {\n  const collection = db.collection(process.env.dbcollection);\n  bcrypt.hash(password, saltRounds, function (err, hash) {\n    // Store hash in your password DB.\n    collection.insertOne({\n      userId: v4(),\n      email,\n      password: hash\n    }, function (err, userCreated) {\n      assert.equal(err, null);\n      callback(userCreated);\n    });\n  });\n}\n\nexport default ((req, res) => {\n  if (req.method === 'POST') {\n    // signup\n    try {\n      assert.notEqual(null, req.body.email, 'Email required');\n      assert.notEqual(null, req.body.password, 'Password required');\n    } catch (bodyError) {\n      res.status(403).json({\n        error: true,\n        message: bodyError.message\n      });\n    } // verify email does not exist already\n\n\n    client.connect(function (err) {\n      assert.equal(null, err);\n      console.log('Connected to MongoDB server =>');\n      const db = client.db(dbName);\n      const email = req.body.email;\n      const password = req.body.password;\n      findUser(db, email, function (err, user) {\n        if (err) {\n          res.status(500).json({\n            error: true,\n            message: 'Error finding User'\n          });\n          return;\n        }\n\n        if (!user) {\n          // proceed to Create\n          createUser(db, email, password, function (creationResult) {\n            if (creationResult.ops.length === 1) {\n              const user = creationResult.ops[0];\n              const token = jwt.sign({\n                userId: user.userId,\n                email: user.email\n              }, jwtSecret, {\n                expiresIn: 3000 //50 minutes\n\n              });\n              res.status(200).json({\n                token\n              });\n              return;\n            }\n          });\n        } else {\n          // User exists\n          res.status(403).json({\n            error: true,\n            message: 'Email exists'\n          });\n          return;\n        }\n      });\n    });\n  } else {\n    // Handle any other HTTP method\n    res.status(200).json({\n      users: ['Gowtham']\n    });\n  }\n});","map":{"version":3,"sources":["D:/Python/intern/reglog1/pages/api/users.js"],"names":["MongoClient","require","assert","bcrypt","v4","jwt","jwtSecret","saltRounds","url","process","env","dbName","client","useNewUrlParser","useUnifiedTopology","findUser","db","email","callback","collection","dbcollection","findOne","createUser","password","hash","err","insertOne","userId","userCreated","equal","req","res","method","notEqual","body","bodyError","status","json","error","message","connect","console","log","user","creationResult","ops","length","token","sign","expiresIn","users"],"mappings":"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","sourcesContent":["const MongoClient = require('mongodb').MongoClient;\nconst assert = require('assert');\nconst bcrypt = require('bcrypt');\nconst v4 = require('uuid').v4;\nconst jwt = require('jsonwebtoken');\nconst jwtSecret = 'SUPERSECRETE20220';\n\nconst saltRounds = 10;\nconst url = process.env.url;\nconst dbName = process.env.dbName;\n\nconst client = new MongoClient(url, {\n  useNewUrlParser: true,\n  useUnifiedTopology: true,\n});\n\nfunction findUser(db, email, callback) {\n  const collection = db.collection(process.env.dbcollection);\n  collection.findOne({email}, callback);\n}\n\nfunction createUser(db, email, password, callback) {\n  const collection = db.collection(process.env.dbcollection);\n  bcrypt.hash(password, saltRounds, function(err, hash) {\n    // Store hash in your password DB.\n    collection.insertOne(\n      { \n        userId: v4(),\n        email,\n        password: hash,\n      },\n      function(err, userCreated) {\n        assert.equal(err, null);\n        callback(userCreated);\n      },\n    );\n  });\n}\n\nexport default (req, res) => {\n  if (req.method === 'POST') {\n    // signup\n    try {\n      assert.notEqual(null, req.body.email, 'Email required');\n      assert.notEqual(null, req.body.password, 'Password required');\n    } catch (bodyError) {\n      res.status(403).json({error: true, message: bodyError.message});\n    }\n\n    // verify email does not exist already\n    client.connect(function(err) {\n      assert.equal(null, err);\n      console.log('Connected to MongoDB server =>');\n      const db = client.db(dbName);\n      const email = req.body.email;\n      const password = req.body.password;\n\n      findUser(db, email, function(err, user) {\n        if (err) {\n          res.status(500).json({error: true, message: 'Error finding User'});\n          return;\n        }\n        if (!user) {\n          // proceed to Create\n          createUser(db, email, password, function(creationResult) {\n            if (creationResult.ops.length === 1) {\n              const user = creationResult.ops[0];\n              const token = jwt.sign(\n                {userId: user.userId, email: user.email},\n                jwtSecret,\n                {\n                  expiresIn: 3000, //50 minutes\n                },\n              );\n              res.status(200).json({token});\n              return;\n            }\n          });\n        } else {\n          // User exists\n          res.status(403).json({error: true, message: 'Email exists'});\n          return;\n        }\n      });\n    });\n  } else {\n    // Handle any other HTTP method\n    res.status(200).json({users: ['Gowtham']});\n  }\n};\n"]},"metadata":{},"sourceType":"module"}